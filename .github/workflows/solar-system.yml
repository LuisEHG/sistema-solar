name: Sistema Solar Workflow
##nombre del espacio de trabajo

on: 
  workflow_dispatch:
  push:
    branches:
      - main
      - 'feature/*'
env:
  MONGO_URI: ${{ secrets.MONGO_URI }}
  MONGO_USERNAME: ${{ vars.MONGO_USERNAME }}
  MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
    
jobs:
    unit-testing:
        name: Unit Testing
        runs-on: ubuntu-latest
        steps:
        - name: Checkout Repository
          uses: actions/checkout@v4

        - name: Setup NodeJS Version
          uses: actions/setup-node@v4
          with:
            node-version: 18
    
        - name: Install Dependencies
          run: npm install
    
        - name: Wait for MongoDB Atlas
          run: |
            echo "Esperando conexiÃ³n con MongoDB Atlas..."
            sleep 10
    
        - name: Debug Test Environment
          run: |
            echo "ğŸ” InformaciÃ³n del entorno de pruebas:"
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Contenido del directorio:"
            ls -la
            echo ""
            echo "ğŸ“„ package.json scripts:"
            cat package.json | grep -A 10 '"scripts"'
            echo ""
            echo "ğŸ§ª Archivo de test:"
            if [ -f app-test.js ]; then
              echo "app-test.js encontrado"
              echo "Primeras 30 lÃ­neas del archivo de test:"
              head -30 app-test.js
            else
              echo "âŒ app-test.js no encontrado"
            fi
            echo ""
            echo "ğŸ—„ï¸ Verificando configuraciÃ³n de base de datos:"
            if [ -f app.js ]; then
              echo "Buscando configuraciÃ³n de MongoDB en app.js:"
              grep -n -A 3 -B 3 "mongoose\|connect\|database" app.js || echo "No se encontrÃ³ configuraciÃ³n de MongoDB"
            fi
        
        - name: Setup Database
          run: |
            echo "ğŸ—„ï¸ Configurando base de datos 'sistemasolar'..."
            node -e "
            const mongoose = require('mongoose');
            
            async function setupDatabase() {
              try {
                // Conectar a MongoDB - la base de datos 'sistemasolar' ya estÃ¡ especificada en la URI
                await mongoose.connect(process.env.MONGO_URI, {
                  useNewUrlParser: true,
                  useUnifiedTopology: true,
                  serverSelectionTimeoutMS: 15000
                });
                
                console.log('âœ… Conectado a MongoDB Atlas - Base de datos: sistemasolar');
                console.log(\`ğŸ“Š Base de datos actual: \${mongoose.connection.name}\`);
                
                // Crear esquema de ejemplo para planetas
                const planetSchema = new mongoose.Schema({
                  name: { type: String, required: true },
                  distance: Number,
                  diameter: Number,
                  moons: Number,
                  createdAt: { type: Date, default: Date.now }
                });
                
                const Planet = mongoose.model('Planet', planetSchema);
                
                // Verificar si ya existen datos
                const count = await Planet.countDocuments();
                console.log(\`ğŸ“Š Planetas existentes: \${count}\`);
                
                // Si no hay datos, crear algunos de ejemplo
                if (count === 0) {
                  const samplePlanets = [
                    { name: 'Mercurio', distance: 57.9, diameter: 4879, moons: 0 },
                    { name: 'Venus', distance: 108.2, diameter: 12104, moons: 0 },
                    { name: 'Tierra', distance: 149.6, diameter: 12756, moons: 1 },
                    { name: 'Marte', distance: 227.9, diameter: 6792, moons: 2 }
                  ];
                  
                  await Planet.insertMany(samplePlanets);
                  console.log('âœ… Datos de ejemplo del sistema solar insertados');
                  
                  const finalCount = await Planet.countDocuments();
                  console.log(\`ğŸ“Š Total de planetas insertados: \${finalCount}\`);
                } else {
                  console.log('âœ… Base de datos ya contiene datos');
                }
                
                await mongoose.connection.close();
                console.log('âœ… ConfiguraciÃ³n completada');
                
              } catch (err) {
                console.error('âŒ Error configurando base de datos:', err.message);
                if (err.name === 'MongoServerSelectionError') {
                  console.error('ğŸ’¡ Verificar: 1) IP whitelist, 2) Credenciales, 3) Base de datos existe');
                }
                process.exit(1);
              }
            }
            
            setupDatabase();
            "
        
        - name: Simple Test Run
          run: |
            echo "ğŸ§ª Ejecutando prueba simple para diagnosticar..."
            echo "Verificando que Mocha funciona:"
            npx mocha --version
            
            echo ""
            echo "ğŸ“„ Contenido del archivo de pruebas:"
            if [ -f app-test.js ]; then
              echo "--- Primeras 50 lÃ­neas de app-test.js ---"
              head -50 app-test.js
            else
              echo "âŒ No se encontrÃ³ app-test.js"
              echo "ğŸ“ Archivos en el directorio:"
              ls -la
            fi
            
            echo ""
            echo "ğŸ” Ejecutando mocha directamente con reporter spec:"
            npx mocha app-test.js --timeout 10000 --reporter spec --exit || {
              echo "âŒ Mocha fallÃ³ directamente"
              echo "Exit code: $?"
            }
        
        - name: Unit Testing
          run: |
            echo "ğŸ§ª Iniciando pruebas unitarias..."
            echo "Variables de entorno:"
            echo "NODE_ENV: $NODE_ENV"
            echo "MONGO_URI configurado: ${MONGO_URI:0:30}... (truncado)"
            
            # Primero intentar con reporter spec para ver los errores
            echo "ğŸ” Ejecutando tests con reporter spec para debug:"
            npm test -- --reporter spec --timeout 10000 --exit || {
              echo "âŒ Tests fallaron con reporter spec"
              SPEC_EXIT_CODE=$?
              echo "Exit code: $SPEC_EXIT_CODE"
            }
            
            echo ""
            echo "ğŸ” Ejecutando tests con reporter junit para artefactos:"
            # Ejecutar con el reporter original para generar XML
            npm test || {
              echo "âŒ Las pruebas fallaron con exit code: $?"
              echo ""
              echo "ğŸ“‹ Verificando archivos generados..."
              ls -la *.xml 2>/dev/null || echo "No se encontraron archivos XML"
              ls -la test-results* 2>/dev/null || echo "No se encontraron archivos test-results"
              
              echo ""
              echo "ğŸ“‹ Mostrando Ãºltimas lÃ­neas del log si existe:"
              if [ -f npm-debug.log ]; then
                echo "--- npm-debug.log ---"
                tail -20 npm-debug.log
              fi
              
              echo ""
              echo "ğŸ“‹ Intentando encontrar cualquier archivo de salida de tests:"
              find . -name "*.xml" -o -name "*test*" -o -name "*mocha*" 2>/dev/null | head -10
              
              exit 1
            }
          env:
            NODE_ENV: test
            DEBUG: "*"
          
        - name: Archive Test Result
          uses: actions/upload-artifact@v4
          if: always()
          with:
            name: Mocha-Test-Result
            path: |
              test-results.xml
              *.log
              npm-debug.log*
            retention-days: 5
            
        - name: Display Test Logs
          if: failure()
          run: |
            echo "ğŸ” Mostrando logs adicionales si existen:"
            if [ -f npm-debug.log ]; then
              echo "ğŸ“‹ npm-debug.log:"
              cat npm-debug.log
            fi
            if [ -f test-results.xml ]; then
              echo "ğŸ“‹ test-results.xml:"
              cat test-results.xml
            fi